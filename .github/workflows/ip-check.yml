name: IP Hardcode Check

on:
  pull_request:
    branches: [ master, develop ]
  push:
    branches: [ master, develop ]

jobs:
  check-hardcoded-ips:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for hardcoded private IPs
      run: |
        echo "ğŸ” Buscando IPs hardcodeadas en cÃ³digo Python, YAML y configs..."
        
        # Buscar en cÃ³digo Python
        if grep -rn "192\.168\|10\.\|172\.\(1[6-9]\|2[0-9]\|3[0-1]\)\." \
           --include="*.py" \
           --exclude-dir=".venv" \
           --exclude-dir=".git" \
           --exclude-dir="models" \
           core/ agents/ scripts/ tests/ 2>/dev/null; then
          echo "âŒ ERROR: IPs privadas hardcodeadas encontradas en archivos Python"
          echo ""
          echo "Las IPs privadas NO deben estar hardcodeadas en el cÃ³digo."
          echo "Usa variables de entorno en su lugar:"
          echo "  âœ… CORRECTO: api_url = os.getenv('OLLAMA_BASE_URL', 'http://localhost:11434')"
          echo "  âŒ INCORRECTO: api_url = 'http://192.168.1.100:11434'"
          exit 1
        fi
        
        # Buscar en archivos YAML
        if grep -rn "192\.168\|10\.\|172\.\(1[6-9]\|2[0-9]\|3[0-1]\)\." \
           --include="*.yaml" \
           --include="*.yml" \
           --exclude-dir=".venv" \
           --exclude-dir=".git" \
           config/ 2>/dev/null; then
          echo "âŒ ERROR: IPs privadas hardcodeadas encontradas en archivos YAML"
          echo ""
          echo "Usa variables de entorno con \${VAR} syntax:"
          echo "  âœ… CORRECTO: api_url: \${OLLAMA_BASE_URL}"
          echo "  âŒ INCORRECTO: api_url: http://192.168.1.100:11434"
          exit 1
        fi
        
        # Buscar en .env (excepto .env.example que es template)
        if grep -rn "192\.168\|10\.\|172\.\(1[6-9]\|2[0-9]\|3[0-1]\)\." \
           .env 2>/dev/null; then
          echo "âŒ ERROR: IPs privadas encontradas en .env"
          echo ""
          echo "El archivo .env NO debe contener IPs especÃ­ficas de tu red local."
          echo "Usa 'localhost' o dominios:"
          echo "  âœ… CORRECTO: OLLAMA_BASE_URL=http://localhost:11434"
          echo "  âŒ INCORRECTO: OLLAMA_BASE_URL=http://192.168.1.100:11434"
          exit 1
        fi
        
        echo "âœ… No se encontraron IPs hardcodeadas en cÃ³digo activo"
        
    - name: Check for localhost alternatives
      run: |
        echo "ğŸ“ Verificando uso correcto de localhost..."
        
        # Verificar que se usa localhost en defaults
        if ! grep -q "localhost" .env.example 2>/dev/null; then
          echo "âš ï¸  WARNING: .env.example deberÃ­a tener 'localhost' como default seguro"
        fi
        
        echo "âœ… VerificaciÃ³n de localhost completada"
        
    - name: Check documentation placeholders
      run: |
        echo "ğŸ“š Verificando placeholders en documentaciÃ³n..."
        
        # Verificar que docs usan placeholders
        if grep -rn "192\.168\|10\.\|172\.\(1[6-9]\|2[0-9]\|3[0-1]\)\." \
           --include="*.md" \
           README.md docs/OPERATIONS_QUICK_REFERENCE.md docs/UNIFIED_WRAPPER_GUIDE.md 2>/dev/null; then
          echo "âš ï¸  WARNING: DocumentaciÃ³n operativa contiene IPs especÃ­ficas"
          echo "Usa placeholders genÃ©ricos:"
          echo "  âœ… CORRECTO: <OLLAMA_HOST> o \${OLLAMA_BASE_URL}"
          echo "  âŒ INCORRECTO: 192.168.1.100"
          # No falla, solo warning
        else
          echo "âœ… DocumentaciÃ³n usa placeholders correctamente"
        fi
        
    - name: Summary
      if: success()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… IP HARDCODE CHECK: PASSED"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "âœ“ CÃ³digo Python: Sin IPs hardcodeadas"
        echo "âœ“ Archivos YAML: Sin IPs hardcodeadas"
        echo "âœ“ .env: Sin IPs hardcodeadas"
        echo "âœ“ DocumentaciÃ³n: Usando placeholders"
        echo ""
        echo "PolÃ­tica de configuraciÃ³n sin IPs: CUMPLIDA âœ…"
        echo ""
